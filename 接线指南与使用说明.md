ESP32 红外学习与控制工程接线指南 📡
==========================================

## � 项目简介

本项目使用 ESP32 DEVKIT-C 开发板实现红外信号的学习、存储和发射功能。支持多种红外协议（NEC、SONY、RC5等），可以学习遥控器信号并重新发射，实现万能遥控器功能。

## 🔧 硬件清单

### 必需组件
- **ESP32 DEVKIT-C** 开发板 × 1
- **VS1838B** 红外接收头 × 1 
- **IR333C-A** 红外发射管 × 1
- **2N3904** NPN三极管 × 1
- **1kΩ** 电阻 × 1
- **220Ω** 电阻 × 1（LED限流电阻，可选）
- **LED** 指示灯 × 1（可选）
- **面包板** 和 **杜邦线** 若干

### 可选组件
- **示波器**（用于调试时序）
- **万用表**（检查连接）

## 🔌 详细接线图

```
                    ESP32 DEVKIT-C 开发板
         左侧引脚                                 右侧引脚
       ┌───────────┴────────────────────────────┴───────────┐
    EN │●15                                             15●│ GPIO23
   VP/ │●14                                             14●│ GPIO22
GPIO36 │                                                  │
   VN/ │●13                                             13●│ GPIO1/TXD
GPIO39 │                                                  │
   D34/│●12                                             12●│ GPIO3/RXD
GPIO34 │                                                  │
   D35/│●11          ┌─────────────────┐              11●│ GPIO21
GPIO35 │             │    ESP32-D0WDQ6 │                 │
   D32/│●10          │      主芯片     │              10●│ GPIO19
GPIO32 │             │                 │                 │
   D33/│● 9          └─────────────────┘               9●│ GPIO18
GPIO33 │                                                 │
   D25/│● 8                                             8●│ GPIO5  ←── 状态LED
GPIO25 │                                                 │
   D26/│● 7                                             7●│ GPIO17
GPIO26 │                                                 │
   D27/│● 6          ┌──┐      ┌──┐                    6●│ GPIO16
GPIO27 │             │  │      │  │                      │
   D14/│● 5          │  │      │  │                    5●│ GPIO4  ←── 红外发射
GPIO14 │             │  │      │  │                      │
   D12/│● 4          │  │      │  │                    4●│ GPIO2  ←── 红外接收
GPIO12 │             │  │      │  │                      │
   D13/│● 3          │  │      │  │                    3●│ GPIO15
GPIO13 │             │  │      │  │                      │
   GND │● 2          │  │      │  │                    2●│ GND
       │             │  │      │  │                      │
   VIN │● 1          │  │      │  │                    1●│ 3V3
       │             └──┘      └──┘                      │
       └─────────────────┬──────┬───────────────────────┘
                       [BOOT] [RST]
                       这个部分为USB接口
```

## 🔗 具体接线步骤

### 第一步：红外接收器 VS1838B 接线

VS1838B 是一个集成了滤波、放大、解调功能的红外接收头。

```
     VS1838B 红外接收头
         ┌─────┐
      ┌─►│  O  │◄─── 红外信号方向
      │  │ VSS │     (圆形部分朝向信号源)
      │  └─────┘
      │   │   │
      │   │   └── ② GND      (黑线) → ESP32 GND (pin2 右侧)
      │   └────── ① DATA     (白线) → ESP32 GPIO2 (pin4 右侧) 
      └────────── ③ VCC      (红线) → ESP32 3V3 (pin1 右侧)

连接说明：
- 引脚1 (DATA): 连接到 ESP32 的 GPIO2
- 引脚2 (GND):  连接到 ESP32 的 GND
- 引脚3 (VCC):  连接到 ESP32 的 3V3 (3.3V)
```

⚠️ **注意事项：**
- VS1838B 的圆形接收面要朝向红外信号发射源
- 工作距离：5-10cm 效果最佳，最远可达1-2米
- 工作角度：正面 ±45° 范围内

### 第二步：红外发射器 IR333C-A + 三极管电路

由于 ESP32 的输出电流有限，需要使用三极管放大电路来驱动红外发射管。

```
     红外发射驱动电路
     
ESP32 GPIO4 ──[1kΩ]──┐
                      │
                   ┌──┴──┐  2N3904 NPN三极管
                   │  B  │  (基极)
               ┌───┤  C  ├───┐
               │   │  E  │   │
               │   └─────┘   │
               │             │
              ┌┴┐           ┌┴┐
              │ │ IR333C-A  │ │
              │ │ 红外LED   │ │ 
              │+│ (长脚)    │ │
              └┬┘           │ │
               │            │ │
     ESP32 3V3 ┘            └┬┘
                             │
                    ESP32 GND ┘

连接步骤：
1. 2N3904 基极(B) ← [1kΩ电阻] ← ESP32 GPIO4
2. 2N3904 集电极(C) ← IR333C-A 短脚(阴极)
3. 2N3904 发射极(E) → ESP32 GND
4. IR333C-A 长脚(阳极) → ESP32 3V3
```

**2N3904 引脚识别：**
```
    面向平面，缺口向下
       ┌─────┐
       │  E  │ 发射极 (Emitter)
       │  B  │ 基极   (Base) 
       │  C  │ 集电极 (Collector)
       └─────┘
```

### 第三步：状态指示LED（可选）

```
状态LED电路：
ESP32 GPIO5 ──[220Ω]──┬──│>│── LED ──┬── ESP32 GND
                       │              │
                      长脚           短脚
                     (阳极)         (阴极)
```

## 📐 完整连接表

| ESP32 引脚 | 连接设备 | 设备引脚 | 线色建议 | 功能说明 |
|-----------|---------|---------|---------|----------|
| **GPIO2** (右侧pin4) | VS1838B | DATA | 白色 | 红外信号接收 |
| **GPIO4** (右侧pin5) | 1kΩ电阻 | → 2N3904基极 | 黄色 | 红外发射控制 |
| **GPIO5** (右侧pin8) | 220Ω电阻 | → LED正极 | 绿色 | 状态指示(可选) |
| **3V3** (右侧pin1) | VS1838B | VCC | 红色 | 3.3V电源 |
| **3V3** (右侧pin1) | IR333C-A | 长脚(阳极) | 红色 | 红外LED电源 |
| **GND** (右侧pin2) | VS1838B | GND | 黑色 | 接地 |
| **GND** (右侧pin2) | 2N3904 | 发射极 | 黑色 | 接地 |
| **GND** (右侧pin2) | LED | 短脚(阴极) | 黑色 | 接地(可选) |

## ⚡ 电路原理说明

### 红外接收电路
- **VS1838B** 内置了滤波器、放大器和解调器
- 只对 **38kHz** 载波频率的红外信号敏感
- 输出数字信号：无信号时输出高电平(3.3V)，有信号时输出低电平(0V)

### 红外发射电路
- **2N3904** 作为开关管，放大ESP32的输出电流
- **1kΩ电阻** 限制基极电流，保护ESP32和三极管
- **IR333C-A** 发射940nm波长的红外光，载波频率38kHz

### 功率计算
```
IR333C-A 参数：
- 正向电压：约1.2V
- 最大电流：100mA
- 发射功率：约15mW

实际电路电流：
I = (3.3V - 1.2V) / R_internal ≈ 50mA (安全范围内)
```

## � LED状态指示说明

状态LED (GPIO5) 提供直观的系统状态反馈：

### LED状态含义
| LED状态 | 含义 | 说明 |
|---------|------|------|
| **快速闪烁3次** | 🔆 系统启动 | 上电后自动执行，表示系统初始化完成 |
| **持续点亮** | 📡 学习模式 | 进入学习模式时点亮，等待接收红外信号 |
| **快速闪烁2次** | ✅ 信号接收成功 | VS1838B成功接收并存储红外信号 |
| **缓慢闪烁** | 📤 信号发射中 | 正在发射红外信号 |
| **熄灭** | 💤 待机状态 | 系统空闲，等待命令 |

### LED时序图
```
启动时序：
     ┌─┐  ┌─┐  ┌─┐
     │ │  │ │  │ │   (快速闪烁3次)
  ───┘ └──┘ └──┘ └─────  (然后熄灭)
     150ms    150ms

信号接收时序：
     ┌─┐  ┌─┐
     │ │  │ │            (快速闪烁2次)
  ───┘ └──┘ └───────────
     100ms   100ms
```

## �🚀 软件使用指南

### 编译和烧录
1. **激活 PlatformIO 环境**
   ```bash
   C:\Users\28276\.platformio\penv\Scripts\activate
   ```

2. **安装依赖库**
   ```bash
   pio lib install
   ```

3. **编译项目**
   ```bash
   pio run
   ```

4. **烧录固件**
   ```bash
   pio run -t upload
   ```

### 串口命令使用

连接ESP32后，打开串口监视器(波特率115200)，可使用以下命令：

#### 🔧 基础命令
```
help         - 显示所有可用命令
learn        - 进入学习模式
stop         - 停止当前操作  
list         - 列出所有已学习的信号
clear        - 清除所有已学习信号
```

#### 📡 发射命令
```
send <id>    - 发射指定ID的信号(带3次重试机制)
repeat <id> <times> - 重复发射信号指定次数
delete <id>  - 删除指定ID的信号
```

#### 🔍 调试命令  
```
info <id>    - 显示信号基本信息
detail <id>  - 显示超详细信号解析(含NEC协议完整分析)
raw <id>     - 显示原始时序数据
test         - 测试发射器功能
```

### 使用示例

1. **学习遥控器信号**
   ```
   > learn
   进入学习模式...
   请将遥控器对准接收器(距离5-10cm)，然后按下要学习的按键
   ```

2. **查看学习到的信号**
   ```
   > list
   已学习的信号列表：
   ID | 协议    | 值         | 位数 | 名称
   ---|---------|------------|------|----------
    1 | NEC     | 0xFF00FF   |   32 | Signal_1
    2 | SONY    | 0x540C     |   12 | Signal_2
   ```

3. **详细分析信号**
   ```
   > detail 1
   🔍 信号 ID 1 超详细分析
   =====================================
   📋 基础信息:
      协议: NEC
      数据长度: 32 位
   🎯 NEC协议详细解析:
      地址码: 0xFF (255)
      地址反码: 0x00 (0) ✅
      命令码: 0x00 (0)  
      命令反码: 0xFF (255) ✅
      数据完整性: ✅ 完整
   ```

4. **发射信号**
   ```
   > send 1
   发射信号 ID: 1 (Signal_1)
   尝试发射第 1 次...
   第 1 次发射成功！
   ✅ 发射完成
   ```

## 🔧 故障排除

### 常见问题及解决方案

#### 1. 接收不到红外信号
**现象：** 学习模式下按遥控器无反应

**可能原因及解决：**
- ✅ 检查VS1838B接线是否正确
- ✅ 确认遥控器有电且工作正常
- ✅ 调整距离到5-10cm，正对接收头
- ✅ 检查串口波特率是否为115200
- ✅ 确认GPIO2没有被其他设备占用

#### 2. 发射无效果
**现象：** 发射命令执行但设备无响应

**可能原因及解决：**
- ✅ 检查2N3904三极管接线
- ✅ 确认1kΩ电阻连接正确
- ✅ 检查IR333C-A正负极是否接反
- ✅ 用手机摄像头检查红外LED是否发光
- ✅ 确认学习的信号协议正确

#### 3. 编译错误
**现象：** PlatformIO编译失败

**解决步骤：**
```bash
# 清理项目
pio run -t clean

# 重新安装依赖
pio lib install

# 重新编译
pio run
```

#### 4. 串口无输出
**现象：** 连接后串口监视器无任何显示

**检查项目：**
- ✅ 确认USB线质量良好(建议使用数据线)
- ✅ 检查COM端口是否正确
- ✅ 确认波特率设置为115200
- ✅ 尝试按RST键重启ESP32

## 📊 性能参数

### 技术指标
- **工作电压：** 3.3V
- **工作电流：** 接收模式 < 100mA，发射模式 < 200mA
- **接收距离：** 1-10米 (取决于发射器功率)
- **发射距离：** 3-8米 (取决于环境和目标设备)
- **支持协议：** NEC、SONY、RC5、RC6、SAMSUNG、LG等20+种
- **存储容量：** 最多20个信号(可扩展)
- **响应时间：** < 100ms
- **载波频率：** 38kHz

### 环境要求
- **工作温度：** -10°C ~ +60°C  
- **工作湿度：** 10% ~ 90% (无凝露)
- **存储温度：** -20°C ~ +70°C

## 🎯 项目特色功能

### 1. 智能协议识别
- 自动识别20+种红外协议
- NEC协议完整解析(地址码、命令码、校验位)
- 原始时序数据分析

### 2. 可靠发射机制  
- 3次重试机制，提高成功率
- 发射状态LED指示
- 支持批量重复发射

### 3. 丰富调试信息
- 十六进制、十进制、二进制多格式显示
- 时序特征统计分析
- 数据完整性验证

### 4. 用户友好界面
- 中文命令提示
- 彩色状态显示(✅❌🔍📡等)
- 详细的帮助信息

## 📈 扩展功能建议

### 硬件扩展
- 添加OLED显示屏显示状态
- 增加按键用于离线操作
- 添加WiFi遥控功能
- 集成温湿度传感器

### 软件扩展
- Web界面控制
- 手机APP控制
- 定时任务功能
- 场景模式切换

---

## 📞 技术支持

如有问题，请检查：
1. 硬件连接是否正确
2. 软件版本是否最新  
3. 参考故障排除章节

**祝您使用愉快！** 🎉
```

## 📋 详细接线表

### VS1838B 红外接收器接线
| VS1838B引脚 | ESP32引脚 | 说明 |
|-------------|-----------|------|
| VCC (中间) | 3V3 | 电源正极 3.3V |
| GND (右侧) | GND | 电源负极 |
| DATA (左侧) | GPIO2 | 信号输出 |

### IR333C-A 红外发射器接线
| 组件 | ESP32引脚 | 说明 |
|------|-----------|------|
| 2N3904基极 | GPIO10 (通过1kΩ电阻) | 控制信号 |
| IR333C-A正极 | 5V (通过2N3904集电极) | 红外LED正极 |
| IR333C-A负极 | GND | 红外LED负极 |
| 2N3904发射极 | GND | 三极管发射极 |

## 🔧 电路连接详图

### 红外接收电路 (VS1838B)
```
     ESP32                    VS1838B
   ┌─────────┐               ┌─────────┐
   │  3V3    │───────────────│   VCC   │
   │  GND    │───────────────│   GND   │
   │  GPIO2  │───────────────│  DATA   │
   └─────────┘               └─────────┘
                                │
                                ▼
                           红外信号接收
```

### 红外发射电路 (IR333C-A + 2N3904)
```
      ESP32                2N3904               IR333C-A
   ┌─────────┐               │ C                 ┌─────┐
   │ GPIO10  │──[1kΩ]───────│   ├───────────────│  +  │
   │         │               │ B                 │     │ IR LED
   │  GND    │───────────────│ E                 │  -  │
   │  5V     │─────────────────┘                 └─────┘
   └─────────┘                                      │
                                                    │
                                                  ──┴── GND
```

## 💻 工程文件结构

```
IR_learn_control/
├── platformio.ini          # PlatformIO配置
├── src/
│   ├── main.cpp            # 主程序
│   ├── ir_receiver.h       # 红外接收模块
│   ├── ir_receiver.cpp
│   ├── ir_transmitter.h    # 红外发射模块
│   ├── ir_transmitter.cpp
│   ├── ir_storage.h        # 红外码存储模块
│   ├── ir_storage.cpp
│   └── ir_utils.h          # 红外工具函数
│   └── ir_utils.cpp
├── include/                # 头文件目录
└── lib/                    # 自定义库目录
```

## 🎯 功能特性

### 红外学习功能
- [x] VS1838B接收红外信号
- [x] 自动解码常见红外协议(NEC, Sony, RC5等)
- [x] 信号存储到EEPROM
- [x] 学习状态LED指示

### 红外发射功能  
- [x] IR333C-A发射红外信号
- [x] 支持多种红外协议
- [x] 重复发射功能
- [x] 发射功率可调

### 串口调试功能
- [x] 学习模式命令控制
- [x] 发射命令控制
- [x] 信号查看和管理
- [x] 实时状态显示

## 📟 串口命令列表

### 基础命令
| 命令 | 功能 | 示例 |
|------|------|------|
| `help` | 显示帮助信息 | `help` |
| `learn` | 进入学习模式 | `learn` |
| `stop` | 停止当前操作 | `stop` |
| `list` | 列出已学习信号 | `list` |
| `clear` | 清除所有信号 | `clear` |

### 发射命令
| 命令 | 功能 | 示例 |
|------|------|------|
| `send <id>` | 发射指定ID信号 | `send 1` |
| `repeat <id> <times>` | 重复发射 | `repeat 1 5` |
| `delete <id>` | 删除指定信号 | `delete 1` |

### 调试命令
| 命令 | 功能 | 示例 |
|------|------|------|
| `raw` | 显示原始信号数据 | `raw 1` |
| `info` | 显示信号详细信息 | `info 1` |
| `test` | 测试发射器功能 | `test` |

## 🔄 使用流程

### 1. 学习红外信号
```
1. 串口发送: learn
2. 将遥控器对准VS1838B (距离5-10cm)
3. 按下要学习的遥控器按键
4. 观察串口提示，确认学习成功
5. 重复步骤学习更多按键
```

### 2. 发射红外信号
```
1. 串口发送: list (查看已学习信号)
2. 串口发送: send <信号ID>
3. 观察设备响应
4. 如需重复: repeat <信号ID> <次数>
```

### 3. 信号管理
```
1. 查看信号: info <ID>
2. 删除信号: delete <ID>  
3. 清空所有: clear
4. 查看原始数据: raw <ID>
```

## 🛠️ 硬件测试步骤

### VS1838B接收器测试
1. 上电后串口显示初始化信息
2. 发送 `learn` 命令进入学习模式
3. 用遥控器对准接收器按键
4. 观察串口是否显示接收到的信号

### IR333C-A发射器测试
1. 先学习一个信号
2. 发送 `test` 命令测试发射器
3. 用手机摄像头观察IR LED是否发光
4. 发送 `send 1` 测试实际控制

## 🐛 故障排除

### 接收问题
| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 无法接收信号 | 接线错误 | 检查VS1838B三个引脚连接 |
| 信号不稳定 | 电源不稳定 | 确保3.3V供电充足 |
| 误触发 | 环境光干扰 | 遮挡环境光源测试 |

### 发射问题  
| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 无法发射 | 三极管接线错误 | 检查2N3904 BCE引脚 |
| 距离太近 | 发射功率不足 | 检查5V供电，确认三极管工作 |
| 设备无响应 | 信号不匹配 | 重新学习信号，检查频率 |

## 📝 注意事项

1. **接收器方向**: VS1838B有方向性，正面对准遥控器
2. **发射距离**: 测试时保持1-2米距离  
3. **电源要求**: 确保5V和3.3V供电稳定
4. **环境要求**: 避免强光直射接收器
5. **安全使用**: 不要长时间连续发射，避免过热

## 📊 性能指标

| 参数 | 指标 |
|------|------|
| 接收频率 | 38kHz标准红外 |
| 接收距离 | 5-8米 |
| 发射距离 | 3-5米 |
| 学习容量 | 20个信号 |
| 响应时间 | <100ms |
| 工作电压 | 3.3V/5V |
